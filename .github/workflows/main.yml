name: Validate Pull Request

on:
  pull_request:
    types:
      - opened
      - synchronize
      - edited
      - reopened

jobs:
  validate-PR-issue:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Validate Issue Reference
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
        url: ${{ github.event.pull_request.url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PRNUM: ${{ github.event.pull_request.number }}
        TITLE: ${{ github.event.pull_request.title }}
      run: |
        set -e
        pattern="((Fixes|Resolves) #[0-9]+)"
        # Get the pull request body
        PR_BODY=$(jq -r '.pull_request.body' $GITHUB_EVENT_PATH)

        issue_num=$(echo "$PR_BODY" | grep -o -P "$pattern" | head -n1 | grep -o -E "[0-9]+")
        if [[ -z "$issue_num" ]]; then
            issue_num="No issue number"
        fi
        echo "$issue_num"
        
        IFS="/" read -r -a url_parts <<< "$url"
        
        # Remove the last two elements (repos and the issue number)
        unset url_parts[-1]
        unset url_parts[-1]
        #unset url_parts[3]
        
        # Replace "api." with an empty string in the third element (index 2)
        #url_parts[2]=${url_parts[2]//api./}
        
        
        # Reattach the URL pieces
        url=$(IFS=/; echo "${url_parts[*]}")

        
        # Add the issue number to the URL
        url="${url}/issues/${issue_num}"
        echo "$url"
